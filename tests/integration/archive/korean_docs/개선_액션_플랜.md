# PyHYSPLIT 개선 액션 플랜

## 🎯 목표
HYSPLIT Web과 99% 일치하는 궤적 계산 달성

---

## 📊 현재 상태

### 성능 지표
| 항목 | 현재 | 목표 | 격차 |
|------|------|------|------|
| 수평 오차 (평균) | 34.91 km | < 10 km | -71% 필요 |
| 수평 오차 (중앙값) | 20.92 km | < 5 km | -76% 필요 |
| 고도 오차 (평균) | 202.5 m | < 50 m | -75% 필요 |
| 고도 오차 (중앙값) | 131.6 m | < 30 m | -77% 필요 |
| 일치율 (< 20km) | 48.6% | > 90% | +41.4% 필요 |

### 문제 지역
1. **부산**: 수평 61.77 km, 고도 427.0 m ⚠️
2. **제주**: 수평 49.67 km, 고도 96.8 m
3. **타이베이**: 수평 27.40 km, 고도 414.8 m ⚠️

### 우수 지역 (벤치마크)
1. **오사카**: 수평 12.71 km, 고도 117.2 m ⭐
2. **상하이**: 수평 14.87 km, 고도 317.5 m ⭐

---

## 🔧 Phase 1: 고도 계산 개선 (최우선)

### 목표
고도 오차를 평균 202.5m → 50m로 감소 (75% 개선)

### 문제 분석
- 부산: 427.0 m 평균 오차 (최대 704.4 m)
- 타이베이: 414.8 m 평균 오차 (최대 581.7 m)
- 해양 상공 궤적에서 특히 큰 오차

### 개선 작업

#### 1.1 수직 운동 모델 검증
**파일**: `pyhysplit/vertical_motion.py`

**작업 내용**:
```python
# 현재 코드 검토 항목:
1. omega (기압 수직 속도) 계산 정확도
2. w (기하학적 수직 속도) 변환 정확도
3. 경계층 효과 고려 여부
4. 대류 효과 모델링

# 검증 방법:
- HYSPLIT 원본 코드와 비교
- 단순 테스트 케이스로 검증
- 수직 속도 프로파일 비교
```

**예상 효과**: 고도 오차 30% 감소

#### 1.2 기압 좌표 변환 개선
**파일**: `pyhysplit/coordinate_converter.py`

**작업 내용**:
```python
# 개선 항목:
1. 기압 → 고도 변환 정확도
2. 표준 대기 모델 검증
3. 온도/습도 보정
4. 지형 효과 고려

# 구현:
def pressure_to_altitude_improved(pressure, temperature, humidity):
    """개선된 기압-고도 변환"""
    # 1. 가상 온도 계산
    # 2. 적분 고도 계산
    # 3. 지형 보정
    pass
```

**예상 효과**: 고도 오차 20% 감소

#### 1.3 해양 상공 궤적 특수 처리
**파일**: `pyhysplit/meteorology.py`

**작업 내용**:
```python
# 해양 상공 특수 처리:
1. 해수면 온도 영향 고려
2. 해양 경계층 모델링
3. 해양-육지 전이 구역 처리

# 구현:
def get_vertical_velocity_ocean(lat, lon, pressure):
    """해양 상공 수직 속도 계산"""
    # 해양 특성 반영
    pass
```

**예상 효과**: 부산, 타이베이 고도 오차 50% 감소

---

## 🔧 Phase 2: 풍속 보간 개선

### 목표
수평 오차를 평균 34.91km → 15km로 감소 (57% 개선)

### 문제 분석
- 중간 시점(12시간 전후)에서 오차 증가
- 장거리 궤적에서 오차 누적
- 공간 보간 정확도 부족

### 개선 작업

#### 2.1 3차원 보간 방법 개선
**파일**: `pyhysplit/meteorology.py`

**작업 내용**:
```python
# 현재: 선형 보간
# 개선: 3차 스플라인 보간

from scipy.interpolate import RegularGridInterpolator

class ImprovedMeteorology:
    def __init__(self):
        # 3차 스플라인 보간기 초기화
        self.u_interp = RegularGridInterpolator(
            (lats, lons, levels), 
            u_data, 
            method='cubic'  # 선형 → 3차
        )
    
    def get_wind_cubic(self, lat, lon, alt):
        """3차 스플라인 풍속 보간"""
        # 경계 처리 개선
        # 외삽 방지
        pass
```

**예상 효과**: 수평 오차 20% 감소

#### 2.2 시간 보간 정확도 개선
**파일**: `pyhysplit/meteorology.py`

**작업 내용**:
```python
# 개선 항목:
1. 시간 가중치 계산 정확도
2. 경계 시간 처리
3. 캐싱 최적화

def get_wind_at_time_improved(self, time, lat, lon, alt):
    """개선된 시간 보간"""
    # 1. 정확한 시간 가중치
    # 2. 경계 조건 처리
    # 3. 캐시 활용
    pass
```

**예상 효과**: 수평 오차 15% 감소

#### 2.3 경계 조건 처리 개선
**파일**: `pyhysplit/meteorology.py`

**작업 내용**:
```python
# 경계 처리:
1. 데이터 영역 경계 검사
2. 외삽 방지
3. 경계 근처 보간 정확도

def check_bounds_and_interpolate(self, lat, lon, alt):
    """경계 조건 고려 보간"""
    # 경계 검사
    # 안전한 보간
    pass
```

**예상 효과**: 경계 지역 오차 30% 감소

---

## 🔧 Phase 3: 시간 적분 최적화

### 목표
장거리 궤적 오차 누적 방지 (제주 146km → 50km)

### 문제 분석
- 제주: 633km 이동, 최대 146km 오차
- 시간에 따른 오차 누적
- RK4 파라미터 최적화 필요

### 개선 작업

#### 3.1 RK4 파라미터 최적화
**파일**: `pyhysplit/integrator.py`

**작업 내용**:
```python
# 현재 RK4 검증:
1. 시간 스텝 크기 최적화
2. 중간 단계 계산 정확도
3. 오차 추정

class OptimizedRK4:
    def __init__(self, dt=60.0):  # 현재 60초
        self.dt = dt
        self.error_threshold = 1e-6
    
    def step_with_error_control(self, state, wind_func):
        """오차 제어 RK4"""
        # 1. 기본 RK4 계산
        # 2. 오차 추정
        # 3. 필요시 시간 스텝 조정
        pass
```

**예상 효과**: 장거리 오차 25% 감소

#### 3.2 적응형 시간 스텝 구현
**파일**: `pyhysplit/integrator.py`

**작업 내용**:
```python
# 적응형 시간 스텝:
1. 풍속에 따른 시간 스텝 조정
2. 오차 기반 시간 스텝 조정
3. 안정성 보장

def adaptive_timestep(self, wind_speed, current_error):
    """적응형 시간 스텝 계산"""
    # 빠른 풍속 → 작은 시간 스텝
    # 큰 오차 → 작은 시간 스텝
    pass
```

**예상 효과**: 장거리 오차 20% 감소

---

## 🔧 Phase 4: 지형/해양 효과

### 목표
특수 조건에서 정확도 개선

### 개선 작업

#### 4.1 지형 효과 고려
**파일**: `pyhysplit/terrain.py` (신규)

**작업 내용**:
```python
# 지형 효과:
1. 산악 지형 유도 흐름
2. 계곡 바람
3. 지형 차폐 효과

class TerrainEffect:
    def __init__(self, dem_data):
        self.dem = dem_data
    
    def get_terrain_induced_wind(self, lat, lon, alt):
        """지형 유도 풍속"""
        # 지형 경사 계산
        # 유도 풍속 계산
        pass
```

**예상 효과**: 산악 지역 오차 15% 감소

#### 4.2 해양-육지 경계 처리
**파일**: `pyhysplit/boundary.py`

**작업 내용**:
```python
# 경계 처리:
1. 해안선 검출
2. 전이 구역 모델링
3. 해풍/육풍 효과

def get_land_sea_transition(self, lat, lon):
    """해양-육지 전이 효과"""
    # 해안선 거리 계산
    # 전이 효과 모델링
    pass
```

**예상 효과**: 해안 지역 오차 20% 감소

---

## 📅 실행 일정

### Week 1-2: Phase 1 (고도 계산)
- [ ] Day 1-3: 수직 운동 모델 검증
- [ ] Day 4-6: 기압 좌표 변환 개선
- [ ] Day 7-10: 해양 상공 특수 처리
- [ ] Day 11-14: 테스트 및 검증

**마일스톤**: 고도 오차 < 100m

### Week 3-4: Phase 2 (풍속 보간)
- [ ] Day 1-5: 3차원 보간 개선
- [ ] Day 6-10: 시간 보간 개선
- [ ] Day 11-14: 경계 조건 처리

**마일스톤**: 수평 오차 < 20km

### Week 5-6: Phase 3 (시간 적분)
- [ ] Day 1-7: RK4 최적화
- [ ] Day 8-14: 적응형 시간 스텝

**마일스톤**: 장거리 오차 < 60km

### Week 7-8: Phase 4 (특수 효과)
- [ ] Day 1-7: 지형 효과
- [ ] Day 8-14: 해양-육지 경계

**마일스톤**: 전체 오차 < 15km

---

## 🧪 테스트 전략

### 단위 테스트
```python
# tests/unit/test_vertical_motion_improved.py
def test_vertical_velocity_accuracy():
    """수직 속도 계산 정확도 테스트"""
    # HYSPLIT 결과와 비교
    pass

# tests/unit/test_interpolation_improved.py
def test_cubic_interpolation():
    """3차 보간 정확도 테스트"""
    # 알려진 함수로 검증
    pass
```

### 통합 테스트
```python
# tests/integration/test_improved_trajectory.py
def test_busan_trajectory():
    """부산 궤적 개선 검증"""
    # 고도 오차 < 100m 확인
    pass

def test_jeju_long_range():
    """제주 장거리 궤적 검증"""
    # 수평 오차 < 60km 확인
    pass
```

### 회귀 테스트
```python
# tests/integration/test_regression.py
def test_all_locations():
    """전체 8개 지역 회귀 테스트"""
    # 개선 후에도 우수 지역 성능 유지
    assert osaka_error < 15.0  # 오사카 성능 유지
    assert shanghai_error < 20.0  # 상하이 성능 유지
    pass
```

---

## 📊 성공 기준

### Phase 1 완료 기준
- ✅ 고도 오차 평균 < 100m
- ✅ 부산 고도 오차 < 200m
- ✅ 타이베이 고도 오차 < 200m

### Phase 2 완료 기준
- ✅ 수평 오차 평균 < 20km
- ✅ 수평 오차 중앙값 < 10km
- ✅ 일치율 > 70%

### Phase 3 완료 기준
- ✅ 제주 최대 오차 < 80km
- ✅ 장거리 궤적 안정성 확보

### Phase 4 완료 기준
- ✅ 모든 지역 수평 오차 < 30km
- ✅ 모든 지역 고도 오차 < 150m

### 최종 목표 달성 기준
- ✅ 수평 오차 평균 < 10km
- ✅ 고도 오차 평균 < 50m
- ✅ 일치율 > 90%
- ✅ 모든 지역에서 안정적 성능

---

## 🔍 모니터링

### 성능 추적
```python
# tests/integration/track_performance.py
def track_improvement():
    """개선 진행 상황 추적"""
    results = {
        'phase': 1,
        'horizontal_error': 34.91,
        'altitude_error': 202.5,
        'match_rate': 48.6,
        'date': '2026-02-14'
    }
    # 데이터베이스에 저장
    # 그래프 생성
    pass
```

### 주간 리포트
- 매주 금요일: 진행 상황 리포트
- 성능 지표 업데이트
- 문제점 및 해결 방안

---

## 📚 참고 자료

### HYSPLIT 원본 코드
- `HYSPLIT/source/advpnt.f` - 이류 계산
- `HYSPLIT/source/advmet.f` - 기상 데이터 처리
- `HYSPLIT/source/prfcom.f` - 수직 프로파일

### 논문
1. Draxler & Hess (1998) - HYSPLIT 알고리즘
2. Stein et al. (2015) - HYSPLIT 업데이트
3. Rolph et al. (2017) - READY 시스템

### 테스트 데이터
- `tests/integration/hysplit_web_data/` - HYSPLIT Web 결과
- `tests/integration/multi_location_24h_results.json` - PyHYSPLIT 결과

---

## 🎯 예상 결과

### Phase 1 후
- 고도 오차: 202.5m → 100m (51% 개선)
- 부산 고도: 427m → 200m (53% 개선)

### Phase 2 후
- 수평 오차: 34.91km → 18km (48% 개선)
- 일치율: 48.6% → 72% (+23.4%)

### Phase 3 후
- 제주 최대 오차: 146km → 75km (49% 개선)
- 장거리 안정성 확보

### Phase 4 후 (최종)
- 수평 오차: 18km → 8km (77% 개선 from 시작)
- 고도 오차: 100m → 45m (78% 개선 from 시작)
- 일치율: 72% → 92% (+43.4% from 시작)

**최종 목표 달성**: 99% 일치 ✅

---

**작성일**: 2026-02-14
**작성자**: PyHYSPLIT 개발팀
**버전**: 1.0
